set +o xtrace
COW_DIR=$DEST/cow
COW_CONF_DIR=/etc/cow
COW_CONF=$COW_CONF_DIR/cow.conf
COW_BIN_DIR=$COW_DIR/bin

COW_SERVICE_HOST=${COW_SERVICE_HOST:-$SERVICE_HOST}
# Support entry points installation of console scripts
if [[ -d $COW_DIR/bin ]]; then
    COW_BIN_DIR=$COW_DIR/bin
else
    COW_BIN_DIR=$(get_python_exec_prefix)
fi

function init_cow {
    echo_summary "Init Cow"
}

function install_cow {
    echo_summary "Installing Cow"
    setup_develop $COW_DIR
}

function configure_cow {
    echo_summary "Configuring Cow"

    sudo install -d -o $STACK_USER $COW_CONF_DIR

    create_cow_conf_file
}

function create_cow_conf_file {
    echo_summary "Creating Cow conf file"

    rm -f $COW_CONF
    
    iniset $COW_CONF DEFAULT debug "$ENABLE_DEBUG_LOG_LEVEL"
    iniset_rpc_backend COW $COW_CONF

    iniset $COW_CONF api host "$(ipv6_unquote $COW_SERVICE_HOST)"
    iniset $COW_CONF oslo_messaging_notifications driver "messagingv2"
    iniset $COW_CONF oslo_messaging_notifications topics "ai.notifications"

    iniset $COW_CONF ai target "node_disk_read_bytes_total_y"
    iniset $COW_CONF ai one_hot_drop "if_binary"
    iniset $COW_CONF ai auto_class_weights "Balanced"
    iniset $COW_CONF ai n_splits "5"
    iniset $COW_CONF ai validation_metrics "f1, roc_auc"
    iniset $COW_CONF ai n_jobs "-1"
    iniset $COW_CONF ai metrics "node_hwmon_temp_celsius, node_cpu_seconds_total, node_memory_MemTotal_bytes, node_memory_MemFree_bytes, node_disk_read_bytes_total_y" 

    iniset $COW_CONF gnocchi_client api_version "1"
    iniset $COW_CONF gnocchi_client endpoint_type "public"
    iniset $COW_CONF gnocchi_client timespan "1440"

    iniset $COW_CONF schedule cron_update_metrics "*/2 0 \* \* \* \*"
    iniset $COW_CONF cron_fit_model= cron_update_metrics "*/2 0 \* \* \* \*"
}


function cleanup_cow {
    echo_summary "Cleanup Cow"
}

function stop_cow {
    echo_summary "Stop Cow"
}

function start_cow {
    echo "---------------------------STARTING COW------------------------------"
    run_process cow-ai "$COW_BIN_DIR/cow-ai --config-file $COW_CONF"
    run_process cow-api "$COW_BIN_DIR/cow-api --config-file $COW_CONF"
}
